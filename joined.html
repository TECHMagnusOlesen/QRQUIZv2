<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>Points</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body {
      background:#f3f4f6;
      color:#111827;
      font:16px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Helvetica,Arial,sans-serif;
      margin:0;

      /* Mobilvenligt layout */
      min-height:100dvh;
      display:flex; align-items:center; justify-content:center;

      /* Behagelig padding + safe areas */
      padding: clamp(12px, 4vw, 24px);
      padding-left: max(16px, env(safe-area-inset-left));
      padding-right: max(16px, env(safe-area-inset-right));
      padding-top: max(16px, env(safe-area-inset-top)) + 52px; /* plads til header */
      padding-bottom: max(16px, env(safe-area-inset-bottom));

      -webkit-text-size-adjust: 100%;
    }
    .header {
      position:fixed; left:0; right:0; top:0; z-index:10;
      background:#1d4ed8; color:#fff; padding:12px 16px; text-align:center;
      font-weight:700; letter-spacing:.3px; box-shadow:0 1px 2px rgba(0,0,0,.08);
    }
    .card {
      width:100%; max-width:560px;
      background:#fff; border:1px solid #e5e7eb; border-radius:16px;
      box-shadow:0 8px 30px rgba(0,0,0,.06); padding:24px;
    }
    h1 { margin:0 0 6px 0; font-size:24px; }
    p { margin:.4em 0; word-break:break-word; }
    .muted { color:#6b7280; }
    .feedback { margin-top:12px; font-size:1.1rem; font-weight:600; }
    .ok { color:#059669; }
    .warn { color:#b45309; }
    .err { color:#dc2626; }
    .center { text-align:center; }
    .big-emoji { font-size:42px; line-height:1; margin-bottom:8px; }
    .grid { display:grid; gap:6px; }
  </style>
</head>
<body>

  <!-- HEADER med event-navn hvis muligt -->
  <div class="header" id="headerTitle">QRQUIZ V2</div>

  <!-- STATE: JOINED -->
  <div id="state-joined" class="card" style="display:none">
    <h1>Velkommen!</h1>
    <div class="grid">
      <p>Du er p√• hold: <strong id="teamName">‚Äì</strong></p>
      <p>Du har <strong id="score">0</strong> point.</p>
      <p id="feedback" class="feedback"></p>
    </div>
  </div>

  <!-- STATE: NOT JOINED -->
  <div id="state-notjoined" class="card center" style="display:none">
    <div class="big-emoji">üèÅ</div>
    <h1>Du er ikke tilf√∏jet p√• et hold</h1>
    <p class="muted">Scan en <strong>hold-QR-kode</strong> for at starte.</p>
    <p class="muted">N√•r du har scannet, bliver du automatisk tilknyttet et hold og kan samle point.</p>
  </div>

  <script>
    async function setHeaderFromEvent() {
      try {
        const evRes = await axios.get('/api/event'); // { event: {id,name} | null }
        if (evRes.data && evRes.data.event && evRes.data.event.name) {
          document.getElementById('headerTitle').textContent = evRes.data.event.name;
        } else {
          document.getElementById('headerTitle').textContent = 'QRQUIZ V2';
        }
      } catch {
        document.getElementById('headerTitle').textContent = 'QRQUIZ V2';
      }
    }

    async function loadState() {
      // Vis event-navn i header uanset om man er joined
      setHeaderFromEvent();

      const params = new URLSearchParams(window.location.search);
      const already    = params.has('already');
      const notInEvent = params.has('notinEvent');
      const pointsRaw  = params.get('points');
      const points     = pointsRaw !== null ? parseInt(pointsRaw, 10) : null;

      const joinedEl = document.getElementById('state-joined');
      const notJoinedEl = document.getElementById('state-notjoined');
      const fb = document.getElementById('feedback');

      joinedEl.style.display = 'none';
      notJoinedEl.style.display = 'none';

      try {
        const res = await axios.get('/api/score'); // { score, name }
        document.getElementById('teamName').innerText = res.data.name || '‚Äì';
        document.getElementById('score').innerText = res.data.score ?? 0;
        joinedEl.style.display = 'block';

        fb.className = 'feedback';
        if (already) {
          fb.textContent = 'Du har allerede svaret p√• denne opgave.';
          fb.classList.add('warn');
        } else if (notInEvent) {
          fb.textContent = 'Denne opgave er ikke en del af det aktuelle event.';
          fb.classList.add('warn');
        } else if (points !== null) {
          if (points > 0) {
            fb.textContent = `Det er rigtigt! Du fik ${points} point.`;
            fb.classList.add('ok');
          } else {
            fb.textContent = 'Det var forkert, ingen point desv√¶rre‚Ä¶';
            fb.classList.add('err');
          }
        } else {
          fb.textContent = '';
        }
      } catch (e) {
        // Ikke p√• et hold
        notJoinedEl.style.display = 'block';
      }
    }

    window.onload = loadState;
  </script>
</body>
</html>
